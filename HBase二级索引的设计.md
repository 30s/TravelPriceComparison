## HBase的局限性
>HBase本身只提供基于行键和全表扫描的查询，而行键索引单一，对于多维度的查询困难(如：对于价格+天数+酒店+交通的多条件组合查询困难)，全表扫描效率低下，所以设计了HBase的二级索引来提高查询效率

## 二级索引的设计

> 其设计思路如(图1)：

<img src="https://github.com/MOBIN-F/TravelPriceComparison/blob/master/%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF%E5%9B%BE.png" width="600" height="310"/>
                                       
                                       (图1) 
> 二级索引的本质就是建立各列值与行键之间的映射关系

如(图1)，当要对F:C1这列建立索引时，只需要建立F:C1各列值到其对应行键的映射关系，如C11->RK1等，这样就完成了对F:C1列值的二级索引的构建，当要查询符合F:C1=C11对应的F:C2的列值时（即根据C1=C11来查询C2的值,图1青色部分）其查询步骤如下：
1. 根据C1=C11到索引数据中查找其对应的RK，查询得到其对应的RK=RK1
2. 得到RK1后就自然能根据RK1来查询C2的值了
这是构建二级索引大概思路，其他组合查询的联合索引的建立也类似。

>(图2)是部分数据在HBase中存储的逻辑视图

<img src="https://github.com/MOBIN-F/TravelPriceComparison/blob/master/%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E9%80%BB%E8%BE%91%E8%A7%86%E5%9B%BE.png" width="600" height="310"/>
                                       
                                       (图2)
表中有两个列族，其中一个是列族INDEX，其并不存储任何的数据，仅仅是为了将索引数据与主数据分开存储（**因为在HBase中同 一列族的数据会被压缩在一直存储**），索引数据的行键格式为：RegionStartKey-索引名-索引键-Rowkwy,其他RegionStartKey就是出发点，因为在创建HBase表时就对表根据出发点进行了预分区，索引键为主数据中各列的列值，Rokwy对应主数据的行键；主数据的行键格式为：出发点-目的地-性价比，所以在存储数据时，**同一出发点 目的地的数据默认是按性价比排序的；索引数据的行键和主数据的行键的前缀都是出发点，所以在存储时相同出发点的索引数据和主数据是存储在同一个Region中的，这样避免了在通过索引得到RK后又去其他Region上查询目标数据，提高了查询效率**。

## 数据的查询查询过程
####假设查询的条件：
>* 出发点：澳门
   
>* 目的地：杭州
   
>* 出游天数：3天
   
>* 酒店等级：4
 
####其查询步骤如下：
1. 首先根据查询条件来确定索引名，根据其查询条件为出游天数据  酒店等级确定索引名为aaa,这样就将查询的范围缩小在索引名为aaa的索引数据区内

2. 根据出游天数的值为3天，酒店等级的值为4，确定符合这两个查询条件的索引数据的行键

3. 得到索引数据行键后就截取其最后的RowKey

4. 最关键的Rowkey得到后就能轻易的获得其对应的列值了，整个查询过程就结束了。

对于其他更为复杂的组合查询的二级索引设计如类似。

##缺点
需要额外的存储空间，属 一种以空间换时间的方式

参考资料

[HBase高性能复杂条件查询引擎](http://blog.csdn.net/bluishglc/article/details/31799255)

[奇虎360 HBASE二级索引的设计与实践](http://www.infoq.com/cn/presentations/qihoo360-hbase-two-stage-index-design-and-practice)